# =============================================================================
# SÄ‚PTÄ‚MÃ‚NA 20: PROGRAMARE PARALELÄ‚ È˜I CONCURENTÄ‚ - Makefile
# =============================================================================
# Curs: Algoritmi È™i Tehnici de Programare (ATP)
# Academia de Studii Economice BucureÈ™ti - CSIE
# =============================================================================

# Compiler È™i flags
CC = gcc
CFLAGS = -Wall -Wextra -std=c11 -g -O2 -pedantic
LDFLAGS = -lpthread -lm
DEBUG_FLAGS = -g -O0 -DDEBUG -fsanitize=thread
RELEASE_FLAGS = -O3 -DNDEBUG

# Directoare
SRC_DIR = src
DATA_DIR = data
TEST_DIR = tests
SOL_DIR = solution
BENCH_DIR = benchmarks
BUILD_DIR = build

# Culori ANSI pentru output
GREEN = \033[0;32m
RED = \033[0;31m
YELLOW = \033[0;33m
CYAN = \033[0;36m
MAGENTA = \033[0;35m
BLUE = \033[0;34m
WHITE = \033[1;37m
BOLD = \033[1m
NC = \033[0m

# Simboluri Unicode
CHECK = âœ“
CROSS = âœ—
ARROW = â¤
GEAR = âš™
ROCKET = ğŸš€
BROOM = ğŸ§¹
TEST_ICON = ğŸ§ª
MEM_ICON = ğŸ”
THREAD_ICON = ğŸ§µ
BENCH_ICON = ğŸ“Š
LOCK_ICON = ğŸ”’

# Targets principale
TARGETS = example1 exercise1 exercise2

# Benchmarks
BENCHMARKS = benchmark_threads benchmark_sequential

# Solutions (pentru instructor)
SOLUTIONS = exercise1_sol exercise2_sol homework1_sol homework2_sol

.PHONY: all clean run test valgrind helgrind help debug release solutions
.PHONY: demo benchmark stats exercise1 exercise2 run-exercise1 run-exercise2

# =============================================================================
# TARGET PRINCIPAL
# =============================================================================

all: banner $(TARGETS)
	@echo ""
	@echo "$(GREEN)$(BOLD)$(CHECK) Toate targeturile au fost compilate cu succes!$(NC)"
	@echo "$(CYAN)$(ARROW) RuleazÄƒ 'make help' pentru a vedea comenzile disponibile$(NC)"
	@echo ""

banner:
	@echo ""
	@echo "$(BLUE)$(BOLD)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)$(BOLD)â•‘  $(THREAD_ICON)  SÄ‚PTÄ‚MÃ‚NA 20: PROGRAMARE PARALELÄ‚ È˜I CONCURENTÄ‚                       â•‘$(NC)"
	@echo "$(BLUE)$(BOLD)â•‘     Threads, Mutex, Semaphores, Atomics, Lock-Free                            â•‘$(NC)"
	@echo "$(BLUE)$(BOLD)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""

# =============================================================================
# COMPILARE TARGETS PRINCIPALE
# =============================================================================

example1: $(SRC_DIR)/example1.c
	@echo "$(CYAN)$(GEAR) Compilare example1.c (demonstraÈ›ie completÄƒ)...$(NC)"
	@$(CC) $(CFLAGS) -o $@ $< $(LDFLAGS)
	@echo "$(GREEN)  $(CHECK) example1 compilat cu succes$(NC)"

exercise1: $(SRC_DIR)/exercise1.c
	@echo "$(CYAN)$(GEAR) Compilare exercise1.c (Producer-Consumer)...$(NC)"
	@$(CC) $(CFLAGS) -o $@ $< $(LDFLAGS)
	@echo "$(GREEN)  $(CHECK) exercise1 compilat$(NC)"

exercise2: $(SRC_DIR)/exercise2.c
	@echo "$(CYAN)$(GEAR) Compilare exercise2.c (Parallel Quick Sort)...$(NC)"
	@$(CC) $(CFLAGS) -o $@ $< $(LDFLAGS)
	@echo "$(GREEN)  $(CHECK) exercise2 compilat$(NC)"

# =============================================================================
# COMPILARE BENCHMARKS
# =============================================================================

benchmarks: $(BENCHMARKS)
	@echo ""
	@echo "$(MAGENTA)$(BOLD)$(CHECK) Benchmark-uri compilate!$(NC)"

benchmark_threads: $(BENCH_DIR)/benchmark_threads.c
	@echo "$(MAGENTA)$(GEAR) Compilare benchmark_threads.c...$(NC)"
	@$(CC) $(CFLAGS) $(RELEASE_FLAGS) -o $@ $< $(LDFLAGS)
	@echo "$(GREEN)  $(CHECK) benchmark_threads compilat$(NC)"

benchmark_sequential: $(BENCH_DIR)/benchmark_sequential.c
	@echo "$(MAGENTA)$(GEAR) Compilare benchmark_sequential.c...$(NC)"
	@$(CC) $(CFLAGS) $(RELEASE_FLAGS) -o $@ $< $(LDFLAGS)
	@echo "$(GREEN)  $(CHECK) benchmark_sequential compilat$(NC)"

# =============================================================================
# COMPILARE SOLUÈšII (DOAR PENTRU INSTRUCTOR)
# =============================================================================

solutions: banner $(SOLUTIONS)
	@echo ""
	@echo "$(MAGENTA)$(BOLD)$(LOCK_ICON) Toate soluÈ›iile au fost compilate!$(NC)"
	@echo ""

exercise1_sol: $(SOL_DIR)/exercise1_sol.c
	@echo "$(MAGENTA)$(GEAR) Compilare exercise1_sol.c...$(NC)"
	@$(CC) $(CFLAGS) -o $@ $< $(LDFLAGS)
	@echo "$(GREEN)  $(CHECK) exercise1_sol compilat$(NC)"

exercise2_sol: $(SOL_DIR)/exercise2_sol.c
	@echo "$(MAGENTA)$(GEAR) Compilare exercise2_sol.c...$(NC)"
	@$(CC) $(CFLAGS) -o $@ $< $(LDFLAGS)
	@echo "$(GREEN)  $(CHECK) exercise2_sol compilat$(NC)"

homework1_sol: $(SOL_DIR)/homework1_sol.c
	@echo "$(MAGENTA)$(GEAR) Compilare homework1_sol.c...$(NC)"
	@$(CC) $(CFLAGS) -o $@ $< $(LDFLAGS)
	@echo "$(GREEN)  $(CHECK) homework1_sol compilat$(NC)"

homework2_sol: $(SOL_DIR)/homework2_sol.c
	@echo "$(MAGENTA)$(GEAR) Compilare homework2_sol.c...$(NC)"
	@$(CC) $(CFLAGS) -o $@ $< $(LDFLAGS)
	@echo "$(GREEN)  $(CHECK) homework2_sol compilat$(NC)"

# =============================================================================
# EXECUÈšIE
# =============================================================================

run: all
	@echo ""
	@echo "$(YELLOW)$(BOLD)$(ROCKET) Rulare exemplu demonstrativ complet...$(NC)"
	@echo "$(YELLOW)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€$(NC)"
	@./example1
	@echo ""
	@echo "$(GREEN)$(CHECK) ExecuÈ›ie finalizatÄƒ$(NC)"

run-exercise1: exercise1
	@echo ""
	@echo "$(YELLOW)$(BOLD)$(ROCKET) Rulare exerciÈ›iul 1 (Producer-Consumer)...$(NC)"
	@echo "$(YELLOW)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€$(NC)"
	@./exercise1 $(DATA_DIR)/log_entries.txt 2 4
	@echo ""

run-exercise2: exercise2
	@echo ""
	@echo "$(YELLOW)$(BOLD)$(ROCKET) Rulare exerciÈ›iul 2 (Parallel Quick Sort)...$(NC)"
	@echo "$(YELLOW)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€$(NC)"
	@./exercise2 $(DATA_DIR)/large_numbers.txt 4
	@echo ""

demo: all
	@echo ""
	@echo "$(YELLOW)$(BOLD)$(ROCKET) DemonstraÈ›ie completÄƒ programare paralelÄƒ...$(NC)"
	@echo ""
	@echo "$(CYAN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(CYAN)â•‘              EXEMPLU COMPLET - TOATE CONCEPTELE               â•‘$(NC)"
	@echo "$(CYAN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@./example1
	@echo ""
	@echo "$(CYAN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(CYAN)â•‘          EXERCIÈšIUL 1: PRODUCER-CONSUMER PATTERN              â•‘$(NC)"
	@echo "$(CYAN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@./exercise1 $(DATA_DIR)/log_entries.txt 2 4 2>/dev/null || ./exercise1
	@echo ""
	@echo "$(CYAN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(CYAN)â•‘           EXERCIÈšIUL 2: PARALLEL QUICK SORT                   â•‘$(NC)"
	@echo "$(CYAN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@./exercise2 $(DATA_DIR)/large_numbers.txt 4 2>/dev/null || ./exercise2
	@echo ""
	@echo "$(GREEN)$(BOLD)$(CHECK) DemonstraÈ›ie completÄƒ finalizatÄƒ!$(NC)"

# =============================================================================
# BENCHMARK
# =============================================================================

benchmark: benchmarks
	@echo ""
	@echo "$(YELLOW)$(BOLD)$(BENCH_ICON) Rulare benchmark paralel vs secvenÈ›ial...$(NC)"
	@echo "$(YELLOW)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€$(NC)"
	@echo ""
	@echo "$(CYAN)Benchmark SecvenÈ›ial:$(NC)"
	@./benchmark_sequential
	@echo ""
	@echo "$(CYAN)Benchmark Paralel (variind numÄƒrul de thread-uri):$(NC)"
	@for t in 1 2 4 8; do \
		echo ""; \
		echo "$(YELLOW)  Threads: $$t$(NC)"; \
		./benchmark_threads $$t; \
	done
	@echo ""
	@echo "$(GREEN)$(CHECK) Benchmark finalizat. ComparÄƒ timpii pentru speedup!$(NC)"

# =============================================================================
# TESTE AUTOMATE
# =============================================================================

test: all
	@echo ""
	@echo "$(YELLOW)$(BOLD)$(TEST_ICON) Rulare teste automate...$(NC)"
	@echo ""
	@echo "$(CYAN)Test 1: Producer-Consumer correctness$(NC)"
	@./exercise1 2>/dev/null && echo "$(GREEN)  $(CHECK) Test 1 PASSED$(NC)" || echo "$(RED)  $(CROSS) Test 1 FAILED$(NC)"
	@echo ""
	@echo "$(CYAN)Test 2: Parallel Sort correctness$(NC)"
	@./exercise2 2>/dev/null && echo "$(GREEN)  $(CHECK) Test 2 PASSED$(NC)" || echo "$(RED)  $(CROSS) Test 2 FAILED$(NC)"
	@echo ""
	@echo "$(GREEN)$(CHECK) Teste finalizate$(NC)"

# =============================================================================
# VERIFICARE MEMORIE È˜I THREAD SAFETY
# =============================================================================

valgrind: all
	@echo ""
	@echo "$(YELLOW)$(BOLD)$(MEM_ICON) Verificare memory leaks cu Valgrind...$(NC)"
	@echo ""
	@echo "$(CYAN)Verificare example1:$(NC)"
	@valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes \
		./example1 2>&1 | grep -E "(ERROR SUMMARY|LEAK SUMMARY|definitely|indirectly)" || true
	@echo ""
	@echo "$(GREEN)$(CHECK) Verificare memorie finalizatÄƒ$(NC)"

helgrind: all
	@echo ""
	@echo "$(YELLOW)$(BOLD)$(LOCK_ICON) Verificare race conditions cu Helgrind...$(NC)"
	@echo ""
	@echo "$(CYAN)Verificare example1:$(NC)"
	@valgrind --tool=helgrind ./example1 2>&1 | grep -E "(ERROR SUMMARY|data race|lock order)" || true
	@echo ""
	@echo "$(GREEN)$(CHECK) Verificare thread safety finalizatÄƒ$(NC)"

tsan: CFLAGS += -fsanitize=thread
tsan: clean all
	@echo ""
	@echo "$(MAGENTA)$(BOLD)$(LOCK_ICON) Build cu ThreadSanitizer completat$(NC)"
	@echo "$(CYAN)RuleazÄƒ executabilele pentru detectare race conditions$(NC)"

# =============================================================================
# DEBUGGING
# =============================================================================

debug: CFLAGS += $(DEBUG_FLAGS)
debug: clean all
	@echo ""
	@echo "$(MAGENTA)$(BOLD)$(GEAR) Build debug completat$(NC)"
	@echo "$(CYAN)FoloseÈ™te: gdb ./example1$(NC)"
	@echo "$(CYAN)Comenzi GDB utile pentru threads:$(NC)"
	@echo "  $(YELLOW)info threads$(NC)     - Lista thread-urilor"
	@echo "  $(YELLOW)thread N$(NC)         - Switch la thread N"
	@echo "  $(YELLOW)thread apply all bt$(NC) - Backtrace toate thread-urile"
	@echo "  $(YELLOW)set scheduler-locking on$(NC) - Lock current thread"

release: CFLAGS += $(RELEASE_FLAGS)
release: clean all benchmarks
	@echo ""
	@echo "$(GREEN)$(BOLD)$(ROCKET) Build release optimizat completat!$(NC)"

# =============================================================================
# STATISTICI
# =============================================================================

stats:
	@echo ""
	@echo "$(CYAN)$(BOLD)$(BENCH_ICON) Statistici Proiect - SÄƒptÄƒmÃ¢na 20$(NC)"
	@echo "$(CYAN)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€$(NC)"
	@echo ""
	@echo "$(YELLOW)FiÈ™iere sursÄƒ:$(NC)"
	@wc -l $(SRC_DIR)/*.c 2>/dev/null || echo "  Nu existÄƒ fiÈ™iere sursÄƒ"
	@echo ""
	@echo "$(YELLOW)Benchmark-uri:$(NC)"
	@wc -l $(BENCH_DIR)/*.c 2>/dev/null || echo "  Nu existÄƒ benchmark-uri"
	@echo ""
	@echo "$(YELLOW)SoluÈ›ii:$(NC)"
	@wc -l $(SOL_DIR)/*.c 2>/dev/null || echo "  Nu existÄƒ soluÈ›ii"
	@echo ""
	@echo "$(YELLOW)Total linii de cod C:$(NC)"
	@find . -name "*.c" -exec cat {} \; 2>/dev/null | wc -l
	@echo ""
	@echo "$(YELLOW)Dimensiune directoare:$(NC)"
	@du -sh $(SRC_DIR) $(SOL_DIR) slides teme $(BENCH_DIR) 2>/dev/null || true

# =============================================================================
# CURÄ‚ÈšARE
# =============================================================================

clean:
	@echo ""
	@echo "$(YELLOW)$(BOLD)$(BROOM) CurÄƒÈ›are artefacte...$(NC)"
	@rm -f $(TARGETS) $(SOLUTIONS) $(BENCHMARKS)
	@rm -f *.o *.out core
	@rm -rf $(BUILD_DIR)
	@rm -f /tmp/test*_output.txt
	@rm -f *.log *.dat
	@echo "$(GREEN)$(CHECK) CurÄƒÈ›are completÄƒ$(NC)"
	@echo ""

# =============================================================================
# AJUTOR
# =============================================================================

help:
	@echo ""
	@echo "$(BLUE)$(BOLD)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)$(BOLD)â•‘                         COMENZI DISPONIBILE                                   â•‘$(NC)"
	@echo "$(BLUE)$(BOLD)â•‘                   $(THREAD_ICON) Programare ParalelÄƒ È™i ConcurentÄƒ                     â•‘$(NC)"
	@echo "$(BLUE)$(BOLD)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(CYAN)$(BOLD)Compilare:$(NC)"
	@echo "  $(GREEN)make$(NC)              - CompileazÄƒ toate targeturile principale"
	@echo "  $(GREEN)make solutions$(NC)    - CompileazÄƒ soluÈ›iile (instructor)"
	@echo "  $(GREEN)make benchmarks$(NC)   - CompileazÄƒ benchmark-urile"
	@echo "  $(GREEN)make debug$(NC)        - Build cu simboluri debug + ThreadSanitizer"
	@echo "  $(GREEN)make release$(NC)      - Build optimizat pentru performanÈ›Äƒ"
	@echo ""
	@echo "$(CYAN)$(BOLD)ExecuÈ›ie:$(NC)"
	@echo "  $(GREEN)make run$(NC)          - RuleazÄƒ exemplul demonstrativ complet"
	@echo "  $(GREEN)make demo$(NC)         - RuleazÄƒ demonstraÈ›ia completÄƒ (toate)"
	@echo "  $(GREEN)make run-exercise1$(NC) - RuleazÄƒ Producer-Consumer"
	@echo "  $(GREEN)make run-exercise2$(NC) - RuleazÄƒ Parallel Quick Sort"
	@echo "  $(GREEN)make benchmark$(NC)    - RuleazÄƒ comparaÈ›ie paralel vs secvenÈ›ial"
	@echo ""
	@echo "$(CYAN)$(BOLD)Testare È™i Verificare:$(NC)"
	@echo "  $(GREEN)make test$(NC)         - RuleazÄƒ testele automate"
	@echo "  $(GREEN)make valgrind$(NC)     - VerificÄƒ memory leaks"
	@echo "  $(GREEN)make helgrind$(NC)     - VerificÄƒ race conditions (Valgrind)"
	@echo "  $(GREEN)make tsan$(NC)         - Build cu ThreadSanitizer"
	@echo ""
	@echo "$(CYAN)$(BOLD)UtilitÄƒÈ›i:$(NC)"
	@echo "  $(GREEN)make stats$(NC)        - AfiÈ™eazÄƒ statistici proiect"
	@echo "  $(GREEN)make clean$(NC)        - È˜terge fiÈ™ierele compilate"
	@echo "  $(GREEN)make help$(NC)         - AfiÈ™eazÄƒ acest mesaj"
	@echo ""
	@echo "$(YELLOW)$(BOLD)Flux de lucru recomandat:$(NC)"
	@echo "  1. $(CYAN)make$(NC)            - CompileazÄƒ proiectul"
	@echo "  2. $(CYAN)make run$(NC)        - Vezi exemplul demonstrativ"
	@echo "  3. $(CYAN)make test$(NC)       - VerificÄƒ corectitudinea"
	@echo "  4. $(CYAN)make helgrind$(NC)   - VerificÄƒ thread safety"
	@echo "  5. $(CYAN)make benchmark$(NC)  - MÄƒsoarÄƒ speedup-ul"
	@echo ""
	@echo "$(WHITE)$(BOLD)Concepte acoperite:$(NC)"
	@echo "  $(THREAD_ICON)  POSIX Threads (pthread)"
	@echo "  $(LOCK_ICON)  Mutex, Semaphore, Condition Variables"
	@echo "  $(BENCH_ICON)  Producer-Consumer, Thread Pool"
	@echo "  $(ROCKET) Parallel Sort, Lock-Free Data Structures"
	@echo ""
