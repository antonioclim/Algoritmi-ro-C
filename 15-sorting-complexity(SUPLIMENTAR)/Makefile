# =============================================================================
# SÄ‚PTÄ‚MÃ‚NA 15: ALGORITMI DE SORTARE AVANSAÈšI È˜I ANALIZA COMPLEXITÄ‚ÈšII - Makefile
# =============================================================================
#
# Utilizare:
#   make          - CompileazÄƒ toate targeturile
#   make run      - RuleazÄƒ exemplul demonstrativ
#   make test     - RuleazÄƒ testele automate
#   make valgrind - VerificÄƒ memory leaks
#   make benchmark- RuleazÄƒ benchmark complet
#   make clean    - È˜terge fiÈ™ierele generate
#   make help     - AfiÈ™eazÄƒ acest ajutor
#
# =============================================================================

# Compilator È™i flaguri
CC = gcc
CFLAGS = -Wall -Wextra -std=c11 -g -pedantic -O2
LDFLAGS = -lm

# Directoare
SRC_DIR = src
DATA_DIR = data
TEST_DIR = tests
SOL_DIR = solution

# Culori pentru output
GREEN = \033[0;32m
RED = \033[0;31m
YELLOW = \033[0;33m
CYAN = \033[0;36m
MAGENTA = \033[0;35m
NC = \033[0m  # No Color
BOLD = \033[1m

# Targeturi principale
EXAMPLE = example1
EXERCISE1 = exercise1
EXERCISE2 = exercise2

# Lista de executabile
TARGETS = $(EXAMPLE) $(EXERCISE1) $(EXERCISE2)

# =============================================================================
# REGULI PRINCIPALE
# =============================================================================

.PHONY: all clean run test valgrind help solutions benchmark generate-data

all: banner $(TARGETS)
	@echo ""
	@echo "$(GREEN)$(BOLD)âœ“ Toate targeturile au fost compilate cu succes!$(NC)"
	@echo ""

banner:
	@echo ""
	@echo "$(CYAN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(CYAN)â•‘     $(BOLD)SÄ‚PTÄ‚MÃ‚NA 15: SORTARE AVANSATÄ‚ & COMPLEXITATE$(NC)$(CYAN)             â•‘$(NC)"
	@echo "$(CYAN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""

# =============================================================================
# COMPILARE TARGETURI
# =============================================================================

$(EXAMPLE): $(SRC_DIR)/example1.c
	@echo "$(YELLOW)âš™ Compilare $(EXAMPLE)...$(NC)"
	@$(CC) $(CFLAGS) -o $@ $< $(LDFLAGS)
	@echo "$(GREEN)  âœ“ $(EXAMPLE) compilat$(NC)"

$(EXERCISE1): $(SRC_DIR)/exercise1.c
	@echo "$(YELLOW)âš™ Compilare $(EXERCISE1)...$(NC)"
	@$(CC) $(CFLAGS) -o $@ $< $(LDFLAGS)
	@echo "$(GREEN)  âœ“ $(EXERCISE1) compilat$(NC)"

$(EXERCISE2): $(SRC_DIR)/exercise2.c
	@echo "$(YELLOW)âš™ Compilare $(EXERCISE2)...$(NC)"
	@$(CC) $(CFLAGS) -o $@ $< $(LDFLAGS)
	@echo "$(GREEN)  âœ“ $(EXERCISE2) compilat$(NC)"

# =============================================================================
# GENERARE DATE DE TEST
# =============================================================================

generate-data:
	@echo ""
	@echo "$(MAGENTA)$(BOLD)â•â•â• GENERARE DATE DE TEST â•â•â•$(NC)"
	@echo ""
	@echo "$(YELLOW)Generare random_10k.txt...$(NC)"
	@shuf -i 1-100000 -n 10000 > $(DATA_DIR)/random_10k.txt 2>/dev/null || \
		(for i in $$(seq 1 10000); do echo $$((RANDOM % 100000)); done > $(DATA_DIR)/random_10k.txt)
	@echo "$(GREEN)  âœ“ random_10k.txt generat$(NC)"
	@echo "$(YELLOW)Generare sorted_10k.txt...$(NC)"
	@seq 1 10000 > $(DATA_DIR)/sorted_10k.txt
	@echo "$(GREEN)  âœ“ sorted_10k.txt generat$(NC)"
	@echo "$(YELLOW)Generare reversed_10k.txt...$(NC)"
	@seq 10000 -1 1 > $(DATA_DIR)/reversed_10k.txt
	@echo "$(GREEN)  âœ“ reversed_10k.txt generat$(NC)"
	@echo "$(YELLOW)Generare nearly_sorted.txt...$(NC)"
	@seq 1 10000 | awk 'BEGIN{srand()} {if(rand()<0.05) print int(rand()*10000); else print}' > $(DATA_DIR)/nearly_sorted.txt
	@echo "$(GREEN)  âœ“ nearly_sorted.txt generat$(NC)"
	@echo ""
	@echo "$(GREEN)$(BOLD)âœ“ Toate fiÈ™ierele de date au fost generate!$(NC)"

# =============================================================================
# RULARE
# =============================================================================

run: $(EXAMPLE)
	@echo ""
	@echo "$(MAGENTA)$(BOLD)â•â•â• RULARE EXEMPLU DEMONSTRATIV â•â•â•$(NC)"
	@echo ""
	@./$(EXAMPLE)

run-ex1: $(EXERCISE1) generate-data
	@echo ""
	@echo "$(MAGENTA)$(BOLD)â•â•â• RULARE EXERCIÈšIUL 1: BENCHMARK SORTARE â•â•â•$(NC)"
	@echo ""
	@./$(EXERCISE1)

run-ex2: $(EXERCISE2)
	@echo ""
	@echo "$(MAGENTA)$(BOLD)â•â•â• RULARE EXERCIÈšIUL 2: EXTERNAL SORT â•â•â•$(NC)"
	@echo ""
	@./$(EXERCISE2)

# =============================================================================
# BENCHMARK
# =============================================================================

benchmark: $(EXAMPLE) generate-data
	@echo ""
	@echo "$(MAGENTA)$(BOLD)â•â•â• BENCHMARK COMPLET ALGORITMI DE SORTARE â•â•â•$(NC)"
	@echo ""
	@echo "$(YELLOW)Rulare benchmark pe toate tipurile de date...$(NC)"
	@./$(EXAMPLE) --benchmark
	@echo ""
	@echo "$(GREEN)$(BOLD)â•â•â• BENCHMARK COMPLET â•â•â•$(NC)"

# =============================================================================
# TESTARE
# =============================================================================

test: $(EXERCISE1) $(EXERCISE2)
	@echo ""
	@echo "$(MAGENTA)$(BOLD)â•â•â• RULARE TESTE AUTOMATE â•â•â•$(NC)"
	@echo ""
	@echo "$(YELLOW)Test 1: ExerciÈ›iul 1 (Benchmark Sortare)...$(NC)"
	@if [ -f $(TEST_DIR)/test1_input.txt ]; then \
		./$(EXERCISE1) < $(TEST_DIR)/test1_input.txt > /tmp/test1_output.txt 2>&1; \
		if diff -q /tmp/test1_output.txt $(TEST_DIR)/test1_expected.txt > /dev/null 2>&1; then \
			echo "$(GREEN)  âœ“ Test 1 PASSED$(NC)"; \
		else \
			echo "$(RED)  âœ— Test 1 FAILED$(NC)"; \
			echo "    DiferenÈ›e:"; \
			diff /tmp/test1_output.txt $(TEST_DIR)/test1_expected.txt | head -10 || true; \
		fi; \
	else \
		echo "$(YELLOW)  âš  FiÈ™ier test negÄƒsit, rulare simplÄƒ...$(NC)"; \
		./$(EXERCISE1) --quick-test > /dev/null 2>&1 && echo "$(GREEN)  âœ“ ExerciÈ›iul 1 ruleazÄƒ$(NC)"; \
	fi
	@echo ""
	@echo "$(YELLOW)Test 2: ExerciÈ›iul 2 (External Sort)...$(NC)"
	@if [ -f $(TEST_DIR)/test2_input.txt ]; then \
		./$(EXERCISE2) < $(TEST_DIR)/test2_input.txt > /tmp/test2_output.txt 2>&1; \
		if diff -q /tmp/test2_output.txt $(TEST_DIR)/test2_expected.txt > /dev/null 2>&1; then \
			echo "$(GREEN)  âœ“ Test 2 PASSED$(NC)"; \
		else \
			echo "$(RED)  âœ— Test 2 FAILED$(NC)"; \
		fi; \
	else \
		echo "$(YELLOW)  âš  FiÈ™ier test negÄƒsit, rulare simplÄƒ...$(NC)"; \
		./$(EXERCISE2) --quick-test > /dev/null 2>&1 && echo "$(GREEN)  âœ“ ExerciÈ›iul 2 ruleazÄƒ$(NC)"; \
	fi
	@echo ""
	@echo "$(GREEN)$(BOLD)â•â•â• TESTARE COMPLETÄ‚ â•â•â•$(NC)"

# =============================================================================
# VALGRIND - VERIFICARE MEMORY LEAKS
# =============================================================================

valgrind: $(EXAMPLE)
	@echo ""
	@echo "$(MAGENTA)$(BOLD)â•â•â• VERIFICARE MEMORY LEAKS CU VALGRIND â•â•â•$(NC)"
	@echo ""
	@if command -v valgrind > /dev/null 2>&1; then \
		echo "$(YELLOW)Verificare $(EXAMPLE)...$(NC)"; \
		valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes \
			--error-exitcode=1 ./$(EXAMPLE) --quick 2>&1 | tail -20; \
		echo ""; \
	else \
		echo "$(RED)Valgrind nu este instalat!$(NC)"; \
		echo "InstalaÈ›i cu: sudo apt install valgrind"; \
	fi

valgrind-ex1: $(EXERCISE1)
	@echo "$(YELLOW)Verificare $(EXERCISE1)...$(NC)"
	@valgrind --leak-check=full ./$(EXERCISE1) --quick 2>&1 | tail -15

valgrind-ex2: $(EXERCISE2)
	@echo "$(YELLOW)Verificare $(EXERCISE2)...$(NC)"
	@valgrind --leak-check=full ./$(EXERCISE2) --quick 2>&1 | tail -15

# =============================================================================
# SOLUÈšII (doar pentru instructori)
# =============================================================================

solutions:
	@echo ""
	@echo "$(MAGENTA)$(BOLD)â•â•â• COMPILARE SOLUÈšII â•â•â•$(NC)"
	@echo ""
	@if [ -d $(SOL_DIR) ]; then \
		for f in $(SOL_DIR)/*.c; do \
			if [ -f "$$f" ]; then \
				name=$$(basename "$$f" .c); \
				echo "$(YELLOW)âš™ Compilare $$name...$(NC)"; \
				$(CC) $(CFLAGS) -o $(SOL_DIR)/$$name $$f $(LDFLAGS) && \
				echo "$(GREEN)  âœ“ $$name compilat$(NC)"; \
			fi; \
		done; \
	else \
		echo "$(YELLOW)Directorul solution/ nu existÄƒ.$(NC)"; \
	fi

# =============================================================================
# CURÄ‚ÈšARE
# =============================================================================

clean:
	@echo ""
	@echo "$(YELLOW)ğŸ§¹ CurÄƒÈ›are fiÈ™iere generate...$(NC)"
	@rm -f $(TARGETS)
	@rm -f $(SOL_DIR)/exercise1_sol $(SOL_DIR)/exercise2_sol
	@rm -f $(SOL_DIR)/homework1_sol $(SOL_DIR)/homework2_sol
	@rm -f *.o *.out
	@rm -f /tmp/test*_output.txt
	@rm -f /tmp/run_*.txt /tmp/sorted_*.txt
	@echo "$(GREEN)âœ“ CurÄƒÈ›are completÄƒ$(NC)"
	@echo ""

# =============================================================================
# AJUTOR
# =============================================================================

help:
	@echo ""
	@echo "$(CYAN)$(BOLD)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(CYAN)$(BOLD)â•‘     SÄ‚PTÄ‚MÃ‚NA 15: SORTARE - COMENZI DISPONIBILE               â•‘$(NC)"
	@echo "$(CYAN)$(BOLD)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(BOLD)Compilare:$(NC)"
	@echo "  $(GREEN)make$(NC)            - CompileazÄƒ toate targeturile"
	@echo "  $(GREEN)make example1$(NC)   - CompileazÄƒ doar exemplul"
	@echo "  $(GREEN)make exercise1$(NC)  - CompileazÄƒ exerciÈ›iul 1"
	@echo "  $(GREEN)make exercise2$(NC)  - CompileazÄƒ exerciÈ›iul 2"
	@echo ""
	@echo "$(BOLD)ExecuÈ›ie:$(NC)"
	@echo "  $(GREEN)make run$(NC)        - RuleazÄƒ exemplul demonstrativ"
	@echo "  $(GREEN)make run-ex1$(NC)    - RuleazÄƒ exerciÈ›iul 1 (Benchmark)"
	@echo "  $(GREEN)make run-ex2$(NC)    - RuleazÄƒ exerciÈ›iul 2 (External Sort)"
	@echo "  $(GREEN)make benchmark$(NC)  - Benchmark complet pe toate algoritmii"
	@echo ""
	@echo "$(BOLD)Date:$(NC)"
	@echo "  $(GREEN)make generate-data$(NC) - GenereazÄƒ fiÈ™iere de test"
	@echo ""
	@echo "$(BOLD)Testare:$(NC)"
	@echo "  $(GREEN)make test$(NC)       - RuleazÄƒ testele automate"
	@echo "  $(GREEN)make valgrind$(NC)   - VerificÄƒ memory leaks"
	@echo ""
	@echo "$(BOLD)Utilitare:$(NC)"
	@echo "  $(GREEN)make clean$(NC)      - È˜terge fiÈ™ierele generate"
	@echo "  $(GREEN)make help$(NC)       - AfiÈ™eazÄƒ acest mesaj"
	@echo ""

# =============================================================================
# SFÃ‚RÈ˜IT MAKEFILE
# =============================================================================
